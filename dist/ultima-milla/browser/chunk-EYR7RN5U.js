import{$ as c,$a as O,A as w,Ab as Me,Bb as xe,Cb as Se,D as Y,Db as we,Eb as ye,F as p,Fb as Ae,Gb as Ee,H as m,Ha as re,Hb as De,Ib as z,J as N,Ja as le,Jb as Pe,Kb as Oe,Lb as j,M as r,Mb as $,N as a,Nb as U,O as M,Ob as I,P as u,Pb as Te,Q as f,Qa as A,Qb as G,Rb as ke,S as x,Sa as ce,Sb as Ie,T as d,Tb as Ve,U as C,Ua as se,Wa as E,X as B,Xa as D,Y as q,Ya as me,Z as H,Za as P,aa as S,ab as T,b as Q,ba as g,bb as pe,ca as J,cb as de,da as K,ea as X,f as W,fa as Z,ga as L,ha as ee,ia as te,ib as ue,m as b,mb as fe,n as v,nb as he,oa as ie,ob as ge,pa as oe,sa as ne,ta as y,ub as k,wb as _e,x as s,xb as Ce,ya as ae,yb as be,z as h,zb as ve}from"./chunk-X3YI3SXE.js";function Qe(i,t){if(i&1&&(r(0,"mat-option",9),c(1),a()),i&2){let e=t.$implicit;m("value",e.nombreUsuario),s(),g(" ",e.nombreUsuario," ")}}var V=class i{constructor(t,e,o){this.dialogRef=t;this.data=e;this.authService=o}tipoEntrega=null;choferSeleccionado=null;choferesDisponibles=[];ngOnInit(){this.authService.getDataUser().subscribe({next:t=>{this.choferesDisponibles=t.filter(e=>e.rol==="chofer"&&!this.data.choferesBloqueados.includes(e.nombreUsuario))},error:t=>console.error("Error al cargar usuarios:",t)})}seleccionarTipo(t){this.tipoEntrega=t}confirmar(){if(!this.tipoEntrega||!this.choferSeleccionado){alert("Debe seleccionar tipo de entrega y un chofer");return}this.dialogRef.close({tipoEntrega:this.tipoEntrega,chofer:this.choferSeleccionado})}cancelar(){this.dialogRef.close(null)}static \u0275fac=function(e){return new(e||i)(h(fe),h(he),h(k))};static \u0275cmp=w({type:i,selectors:[["app-asignar-despacho-modal"]],decls:21,vars:7,consts:[[1,"section-title"],[1,"button-group"],["mat-stroked-button","",3,"click"],["appearance","fill"],["placeholder","Chofer",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"actions"],["mat-button","",1,"cancel",3,"click"],["mat-button","",1,"confirm",3,"click"],[3,"value"]],template:function(e,o){e&1&&(r(0,"h2"),c(1),a(),r(2,"div",0),c(3,"Selecciona el tipo de entrega:"),a(),r(4,"div",1)(5,"button",2),d("click",function(){return o.seleccionarTipo("Interno")}),c(6," Interno "),a(),r(7,"button",2),d("click",function(){return o.seleccionarTipo("Externo")}),c(8," Externo "),a()(),r(9,"div",0),c(10,"Selecciona el chofer:"),a(),r(11,"mat-form-field",3)(12,"mat-label"),c(13,"Chofer"),a(),r(14,"mat-select",4),X("ngModelChange",function(l){return K(o.choferSeleccionado,l)||(o.choferSeleccionado=l),l}),p(15,Qe,2,2,"mat-option",5),a()(),r(16,"div",6)(17,"button",7),d("click",function(){return o.cancelar()}),c(18,"Cancelar"),a(),r(19,"button",8),d("click",function(){return o.confirmar()}),c(20,"Confirmar"),a()()),e&2&&(s(),g("Asignar despacho - Folio ",o.data.folio,""),s(4),N("selected",o.tipoEntrega==="Interno"),s(2),N("selected",o.tipoEntrega==="Externo"),s(7),J("ngModel",o.choferSeleccionado),s(),m("ngForOf",o.choferesDisponibles))},dependencies:[y,ie,T,O,D,E,ce,U,$,j,P,A,re,le],styles:["[_nghost-%COMP%]{display:block;padding:24px;border-radius:16px;background-color:#212121;color:#fff;max-width:400px;max-height:90vh;overflow:hidden;box-shadow:0 8px 24px #0009;font-family:Segoe UI,sans-serif}h2[_ngcontent-%COMP%]{font-size:20px;font-weight:600;margin-bottom:24px;color:#ff9800;text-align:center}.section-title[_ngcontent-%COMP%]{font-size:14px;margin-bottom:8px;color:#ccc}.button-group[_ngcontent-%COMP%]{display:flex;gap:12px;justify-content:center;margin-bottom:24px}.button-group[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{border-radius:24px;padding:8px 20px;min-width:100px}.button-group[_ngcontent-%COMP%]   button.selected[_ngcontent-%COMP%]{background-color:#ff9800;color:#212121}mat-form-field[_ngcontent-%COMP%]{width:100%;margin-bottom:24px}mat-form-field[_ngcontent-%COMP%]   .mat-form-field-flex[_ngcontent-%COMP%]{background-color:#2a2a2a;border-radius:8px}mat-form-field[_ngcontent-%COMP%]   .mat-select-arrow[_ngcontent-%COMP%]{color:#ff9800}.actions[_ngcontent-%COMP%]{display:flex;justify-content:space-between}.actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{border-radius:20px;font-weight:500;padding:6px 16px}.actions[_ngcontent-%COMP%]   button.confirm[_ngcontent-%COMP%]{background-color:#ff9800;color:#212121}.actions[_ngcontent-%COMP%]   button.cancel[_ngcontent-%COMP%]{background-color:transparent;color:#ff9800}"]})};var F=class i{transform(t){if(!t)return"";let e=t.toString().padStart(6,"0"),o=parseInt(e.substring(0,2),10),n=e.substring(2,4),l=e.substring(4,6);return`${o}:${n}:${l}`}static \u0275fac=function(e){return new(e||i)};static \u0275pipe=Y({name:"formatTime",type:i,pure:!0})};var Ye=()=>[8,10,15,20];function Je(i,t){if(i&1){let e=x();r(0,"button",30),d("click",function(){b(e);let n=C();return v(n.iniciarAsignacionRuta())}),c(1," Iniciar asignaci\xF3n de ruta "),a()}}function Ke(i,t){if(i&1){let e=x();r(0,"button",31),d("click",function(){b(e);let n=C();return v(n.finalizarAsignacionRuta())}),c(1," Finalizar asignaci\xF3n "),a()}}function Xe(i,t){i&1&&(r(0,"button",32),c(1," Ruta bloqueada hasta que el chofer finalice su despacho "),a())}function Ze(i,t){if(i&1){let e=x();r(0,"th",33)(1,"mat-checkbox",34),d("change",function(n){b(e);let l=C();return v(l.toggleAllRows(n))}),a()()}if(i&2){let e=C();s(),m("checked",e.isAllSelected())("indeterminate",e.selection.hasValue()&&!e.isAllSelected())}}function et(i,t){if(i&1){let e=x();r(0,"td",35)(1,"mat-checkbox",36),d("click",function(n){return b(e),v(n.stopPropagation())})("change",function(){let n=b(e).$implicit,l=C();return v(l.toggleRow(n))}),a()()}if(i&2){let e=t.$implicit,o=C();s(),m("checked",o.selection.isSelected(e))}}function tt(i,t){i&1&&(r(0,"th",33),c(1,"Folio"),a())}function it(i,t){if(i&1&&(r(0,"td",35),c(1),a()),i&2){let e=t.$implicit;s(),S(e.FolioNum)}}function ot(i,t){i&1&&(r(0,"th",33),c(1,"C\xF3digo Cliente"),a())}function nt(i,t){if(i&1&&(r(0,"td",35),c(1),a()),i&2){let e=t.$implicit;s(),S(e["Cod.Cliente"])}}function at(i,t){i&1&&(r(0,"th",33),c(1,"Nombre Cliente"),a())}function rt(i,t){if(i&1&&(r(0,"td",35),c(1),a()),i&2){let e=t.$implicit;s(),S(e.NombreCliente)}}function lt(i,t){i&1&&(r(0,"th",37),c(1,"Fecha"),a())}function ct(i,t){if(i&1&&(r(0,"td",35),c(1),L(2,"date"),a()),i&2){let e=t.$implicit;s(),g(" ",te(2,1,e.FechaDocumento,"dd/MM/yyyy")," ")}}function st(i,t){i&1&&(r(0,"th",33),c(1,"Hora"),a())}function mt(i,t){if(i&1&&(r(0,"td",35),c(1),L(2,"formatTime"),a()),i&2){let e=t.$implicit;s(),g(" ",ee(2,1,e.HoraCreacion)," ")}}function pt(i,t){i&1&&(r(0,"th",33),c(1,"Direcci\xF3n"),a())}function dt(i,t){if(i&1&&(r(0,"td",35),c(1),a()),i&2){let e=t.$implicit;s(),S(e.Direccion)}}function ut(i,t){i&1&&(r(0,"th",33),c(1,"Comentarios"),a())}function ft(i,t){if(i&1&&(r(0,"td",35),c(1),a()),i&2){let e=t.$implicit;s(),g(" ",e.Comentarios.length?e.Comentarios:"Sin comentarios"," ")}}function ht(i,t){i&1&&M(0,"tr",38)}function gt(i,t){i&1&&M(0,"tr",39)}var Re=class i{constructor(t,e,o){this.authService=t;this.dialog=e;this.router=o}displayedColumns=["select","FolioNum","CodCliente","NombreCliente","FechaDocumento","HoraCreacion","Direccion","Comentarios"];dataSource=new z([]);selection=new _e(!0,[]);despachosExistentes=new Set;paginator;sort;rutaActiva=!1;rutaBloqueada=!1;choferesConRutaActiva=[];ngOnInit(){this.chargeData(),this.verificarRutasActivas(),this.rutaBloqueada&&alert("La ruta ha sido bloqueada porque un chofer inici\xF3 el despacho. No se pueden asignar m\xE1s pedidos hasta que finalice."),setInterval(()=>{this.verificarRutasActivas()},8e3)}bloqueoNotificado=!1;verificarRutasActivas(){Promise.all([this.authService.getDataDispatch().toPromise(),this.authService.getDataUser().toPromise()]).then(([t,e])=>{let o=e.filter(l=>l.rol==="chofer").map(l=>l.nombreUsuario),n=t.filter(l=>l.estado==="Despacho"&&l.fechaDespacho&&o.includes(l.chofer));this.choferesConRutaActiva=n.map(l=>l.chofer),this.choferesConRutaActiva.length>0&&!this.bloqueoNotificado&&(alert("Uno o m\xE1s choferes ya iniciaron su ruta. No se les puede asignar m\xE1s despachos."),this.bloqueoNotificado=!0),this.choferesConRutaActiva.length===0&&(this.bloqueoNotificado=!1)}).catch(t=>{console.error("Error al verificar rutas activas con usuarios:",t)})}iniciarAsignacionRuta(){this.rutaBloqueada||(this.rutaActiva=!0)}finalizarAsignacionRuta(){this.rutaActiva=!1}chargeData(){this.authService.getDataDispatch().subscribe({next:t=>{let e=new Set(t.map(o=>Number(o.folio)).filter(o=>!isNaN(o)));this.authService.getData().subscribe({next:o=>{o.forEach(l=>{let _=new Date(l.FechaDocumento),R=l.HoraCreacion.toString().padStart(6,"0"),Ne=parseInt(R.substring(0,2),10),Be=parseInt(R.substring(2,4),10),qe=parseInt(R.substring(4,6),10);_.setHours(Ne,Be,qe),l._fechaHoraCompleta=_});let n=o.filter(l=>!e.has(Number(l.FolioNum)));this.dataSource=new z(n),this.dataSource.sortingDataAccessor=(l,_)=>_==="FechaDocumento"?l._fechaHoraCompleta:l[_],this.dataSource.sort=this.sort,setTimeout(()=>{this.sort.active="FechaDocumento",this.sort.direction="desc",this.sort.sortChange.emit({active:"FechaDocumento",direction:"desc"})}),this.dataSource.paginator=this.paginator},error:o=>console.error("Error al obtener datos desde la vista:",o)})},error:t=>console.error("Error al obtener datos desde Mongo:",t)})}applyFilter(t){let e=t.target.value;this.dataSource.filter=e.trim().toLowerCase()}isAllSelected(){let t=this.dataSource.filteredData;return this.selection.selected.length>0&&t.every(e=>this.selection.isSelected(e))}toggleAllRows(t){let e=this.dataSource.filteredData;t.checked?this.selection.select(...e):this.selection.deselect(...e)}toggleRow(t){this.selection.toggle(t)}addToDispatch(){return Q(this,null,function*(){let t=this.selection.selected;if(t.length===0||!this.rutaActiva)return;let e=[],o=[];for(let n of t){let l=yield this.dialog.open(V,{data:{folio:n.FolioNum,choferesBloqueados:this.choferesConRutaActiva},disableClose:!0}).afterClosed().toPromise();if(!l){alert(`Asignaci\xF3n cancelada para el despacho con folio ${n.FolioNum}.`);continue}let _={folio:n.FolioNum,nombreCliente:n.NombreCliente,rutCliente:n["Cod.Cliente"],estado:"Despacho",direccion:n.Direccion,comentarioDespacho:n.Comentarios,tipoEntrega:l.tipoEntrega,chofer:l.chofer,asignadoPor:this.authService.getNombreUsuario()};e.push(W(this.authService.saveData(_)).then(()=>{o.push(n.FolioNum)}))}try{yield Promise.all(e),o.length>0&&alert(`Se registraron ${o.length} despacho(s) correctamente.`),o.forEach(n=>{this.despachosExistentes.add(n)}),this.selection.clear(),this.dataSource.data=this.dataSource.data.filter(n=>!this.despachosExistentes.has(n.FolioNum)),this.verificarRutasActivas()}catch(n){console.error("Error al guardar despachos:",n),alert("Hubo un error al crear los despachos. Por favor, int\xE9ntelo de nuevo.")}})}logout(){localStorage.removeItem("token"),localStorage.removeItem("rol"),localStorage.removeItem("userId"),localStorage.clear(),this.router.navigate(["/login"])}static \u0275fac=function(e){return new(e||i)(h(k),h(ge),h(ae))};static \u0275cmp=w({type:i,selectors:[["app-available-view"]],viewQuery:function(e,o){if(e&1&&(B(I,5),B(G,5)),e&2){let n;q(n=H())&&(o.paginator=n.first),q(n=H())&&(o.sort=n.first)}},decls:50,vars:11,consts:[["mat-button","","color","warn",3,"click"],[1,"mat-elevation-z4",2,"overflow-x","auto"],[1,"search-bar-container"],["appearance","outline",1,"search-field"],["matPrefix",""],["matInput","","placeholder","Buscar",3,"keyup"],[2,"display","flex","justify-content","flex-end","width","100%","align-items","center","padding","0px 30px"],[2,"display","flex","justify-content","center"],["mat-raised-button","","color","primary",3,"click","disabled"],[2,"padding","10px 30px"],["mat-raised-button","","color","primary","class","dButton",3,"click",4,"ngIf"],["mat-raised-button","","color","warn","class","dButton",3,"click",4,"ngIf"],["mat-stroked-button","","disabled","","style","margin-left: 10px",4,"ngIf"],["src","assets/vivipra.png","alt","vivipra",2,"width","100px"],[1,"desktop-view"],["mat-table","","matSort","",1,"mat-table",3,"dataSource"],["matColumnDef","select"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","FolioNum"],["matColumnDef","CodCliente"],["matColumnDef","NombreCliente"],["matColumnDef","FechaDocumento"],["mat-header-cell","","mat-sort-header","",4,"matHeaderCellDef"],["matColumnDef","HoraCreacion"],["matColumnDef","Direccion"],["matColumnDef","Comentarios"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["showFirstLastButtons","",3,"pageSize","pageSizeOptions"],["mat-raised-button","","color","primary",1,"dButton",3,"click"],["mat-raised-button","","color","warn",1,"dButton",3,"click"],["mat-stroked-button","","disabled","",2,"margin-left","10px"],["mat-header-cell",""],[3,"change","checked","indeterminate"],["mat-cell",""],[3,"click","change","checked"],["mat-header-cell","","mat-sort-header",""],["mat-header-row",""],["mat-row",""]],template:function(e,o){e&1&&(r(0,"button",0),d("click",function(){return o.logout()}),r(1,"mat-icon"),c(2,"logout"),a(),c(3,` Cerrar sesi\xF3n
`),a(),r(4,"div",1)(5,"div",2)(6,"div")(7,"mat-form-field",3)(8,"mat-icon",4),c(9,"search"),a(),r(10,"input",5),d("keyup",function(l){return o.applyFilter(l)}),a()()(),r(11,"div",6)(12,"div",7)(13,"button",8),d("click",function(){return o.addToDispatch()}),c(14),a()(),r(15,"div",9),p(16,Je,2,0,"button",10)(17,Ke,2,0,"button",11)(18,Xe,2,0,"button",12),a(),r(19,"div"),M(20,"img",13),a()()(),r(21,"div",14)(22,"table",15),u(23,16),p(24,Ze,2,2,"th",17)(25,et,2,1,"td",18),f(),u(26,19),p(27,tt,2,0,"th",17)(28,it,2,1,"td",18),f(),u(29,20),p(30,ot,2,0,"th",17)(31,nt,2,1,"td",18),f(),u(32,21),p(33,at,2,0,"th",17)(34,rt,2,1,"td",18),f(),u(35,22),p(36,lt,2,0,"th",23)(37,ct,3,4,"td",18),f(),u(38,24),p(39,st,2,0,"th",17)(40,mt,3,3,"td",18),f(),u(41,25),p(42,pt,2,0,"th",17)(43,dt,2,1,"td",18),f(),u(44,26),p(45,ut,2,0,"th",17)(46,ft,2,1,"td",18),f(),p(47,ht,1,0,"tr",27)(48,gt,1,0,"tr",28),a(),M(49,"mat-paginator",29),a()()),e&2&&(s(13),m("disabled",o.selection.selected.length===0||!o.rutaActiva),s(),g(" Asignar ",o.selection.selected.length," pedido/s a despacho "),s(2),m("ngIf",!o.rutaActiva&&!o.rutaBloqueada),s(),m("ngIf",o.rutaActiva),s(),m("ngIf",o.rutaBloqueada&&!o.rutaActiva),s(4),m("dataSource",o.dataSource),s(25),m("matHeaderRowDef",o.displayedColumns),s(),m("matRowDefColumns",o.displayedColumns),s(),m("pageSize",8)("pageSizeOptions",Z(10,Ye)))},dependencies:[y,oe,ne,De,Ce,ve,we,Me,be,ye,xe,Se,Ae,Ee,T,O,de,pe,A,D,E,se,P,me,Oe,Pe,Te,I,ue,G,Ie,ke,Ve,F],styles:[".search-bar-container[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;align-items:center;margin:0 auto;padding:0 30px}.search-field[_ngcontent-%COMP%]{width:100%;max-width:500px;background:#fff;border-radius:12px}[_nghost-%COMP%]     .mat-form-field-outline{border-color:#ccc;border-radius:12px}[_nghost-%COMP%]     .mat-form-field-outline-thick{border-color:#ff9800!important}[_nghost-%COMP%]     .mat-input-element{color:#333}[_nghost-%COMP%]     .mat-form-field-label{color:#888}[_nghost-%COMP%]     .mat-form-field-appearance-outline.mat-focused .mat-form-field-outline-thick{border-color:#ff9800}[_nghost-%COMP%]     .mat-icon{color:#ff9800}[_nghost-%COMP%]     .mat-button{background-color:#ff9800!important;color:#fff!important}table[_ngcontent-%COMP%]{width:100%;border-radius:.5rem .5rem 0 0;overflow:hidden;border-collapse:collapse}table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:#212121;color:#fff;font-weight:600;text-align:center;padding:.75rem;font-size:15px;letter-spacing:.5px;text-transform:uppercase}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.7rem;font-size:.95rem;color:#000;text-align:center;justify-content:center;align-items:center}table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:nth-child(2n)   td[_ngcontent-%COMP%]{background-color:#f5f5f5}table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:nth-child(odd)   td[_ngcontent-%COMP%]{background-color:#fff}h2[_ngcontent-%COMP%]{font-size:24px;font-weight:700;color:#333;text-transform:uppercase;border-left:6px solid #ff9800;padding-left:10px;margin-bottom:.5rem}h3[_ngcontent-%COMP%]{font-size:18px;font-weight:600;color:#424242;margin-top:1rem;margin-bottom:.5rem;padding-left:10px;border-left:4px solid #ffb74d}[_nghost-%COMP%]     button{margin-right:5rem}.desktop-view[_ngcontent-%COMP%]{padding:0 30px}@media (max-width: 600px){.tabla-container[_ngcontent-%COMP%]{padding:.5rem}table[_ngcontent-%COMP%]{font-size:.85rem}table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.5rem}table[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:1.25rem}}.dButton[_ngcontent-%COMP%]{color:#fff!important;background-color:#ff9800!important}"]})};export{Re as AvailableViewComponent};
